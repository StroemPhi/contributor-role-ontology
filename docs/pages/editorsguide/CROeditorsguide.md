# Editors' Guide for CRO developers

# SETTING UP

## Editing environment

1. Install [Protege 5.2](http://protege.stanford.edu/) or higher. Protege 5.5 is currently available and most editors are using this version now.
2. Install any additional plugins from: http://wiki.geneontology.org/index.php/Ontology_editor_plugins 
3. Install the Elk plugin from [https://github.com/liveontologies/elk-reasoner/wiki/GettingElk](https://github.com/liveontologies/elk-reasoner/wiki/GettingElk)
(Put the plugin into the Protege/plugins directory, see instructions below.)

Especially
1. The Term Metadata editor plugin (Alpha), to be found at: http://wiki.geneontology.org/index.php/Ontology_editor_plugins
2. The obsolescence plugin  (see http://wiki.geneontology.org/index.php/Ontology_editor_plugins; note the plugin is called org.nescent.protege.obo-actions.jar).
(Note--these plugins are not great and use is not mandatory)

## PRE-EDIT CHECKLIST

### Setting your ID ranges

Do you have an ID range in the idranges file (cro-idranges.owl), in
the src/ontology/ directory)? If not, Nicole or Marijane can add one for you.

Ensure that you have Protege configured to generate new URIs in your
own range. Note that if you edit multiple files, **you need to check this every time** to ensure that the proper settings are in place. HP URIs should look like this:
http://purl.obolibrary.org/obo/CRO_0000006
Do a test to ensure that the ID generator is working properly.

A word of caution about protege auto-id functionality. Protege will allow reuse of a URI in your range according to the numbering scheme. It will keep track of what you did during last session, but *does not check* for use of the URI before assigning it. Therefore, if you switched between editing another ontology, or added any IDs in your range prior to the switch to OWL, Protege will not know not to start from the beginning. Some tips below to check to see where you are in your range. **Note: if you only edit the HPO and do not edit other ontologies, you will only need to set this up once, Protege will remember your last ID between sessions.**

1. Open the file **cro-idranges.owl** in src/ontology in a text editor (like TextEdit) and check your ID range (start and end). 
2. In Protege, go to the **View** menu, click "render by entity IRI short name (Id)". This will display classes as "CRO_0030021" etc.  

3. Use the search box to search for classes starting within your range, such as "CRO_20" for Marijane's range. Check the "show all results" box to see all of your results.  

4. Find the last used ID in your range, e.g. HP_2000008.  

5. Go to Protege->Preferences, and click the New Entities tab. Set Protege to the next unused ID in your range (e.g., "CRO_00400009") rather than the beginning of the range.  

5. To do so (assuming you are using Protege 5), go to Protege->Preferences window and find the "New Entities" tab. The following settings are correct:
 * Start with "**Specified URI**": http://purl.obolibrary.org/obo/
 * Followed by "/"
 * End with "autogenerated ID"
 * Entity label "custom label": http://www.w3.org/2000/01/rdf-schema#label
 * Autogenerated ID "numeric", prefix "HP_", digit count "7", start (next unused ID in your range), end (last ID in your range)
 * Finally, tick the box "remember last ID between Protege sessions"

For instance, Marijane's range is 2000000-2999999

Note that you can use ctrl-U to see the IRI of the current entity. If you click on "show full IRI", you should see something like this:
http://purl.obolibrary.org/obo/CRO_20000006  

Protege should then remember your last used ID on the computer you are currently using for next time, though you should double check.

(You can ignore this if you do not intend to create new classes)

Finally, go to Protege->Preferences, “New Entities Metadata” tab and set "http://www.geneontology.org/formats/oboInOwl#created_by”. This will ensure that we are all using the same tag to get credit for making new terms.  

### Obsolescence plugin

Get Jim's awesome obsolescence is automatically installed with Protege 5.5. If you do not see it, you can install through the Protege `Check for plugins...` menu. 

### Elk reasoner

Installing ELK:

1) Go to the [ELK pages](https://github.com/liveontologies/elk-reasoner/wiki/GettingElk)
2) Scroll down and click on **Protege Plugin latest build**
3) When downloaded, unzip and copy puli and elk jars (two .jar files) in the unpacked directory.
4) Paste these files in your Protege plugin directory. This is in one of two locations:  
  * ~/.Protege/plugins (note this is usually hidden from finder, but you can see it in the terminal) or
  * Go to Protege in **Applications** (Finder), right click, 'Show package contents' -> Java -> plugins


## GETTING STARTED

### Creatng a new branch

_this content is under development_

Then, open the file cro-edit.owl in Protege

Switch on the Elk reasoner (see how to get plugins above). If you are making changes, be sure to synchronize the reasoner.

### Edit the ontology in Protege:

1. Find parent term in Protege by searching in the search box (at top of screen)
1. Double check that term is not already there
1. Add subclass
1. Add label (URI should be auto-generated)
1. Under annotations, add definition, click OK
1. Annotation on definition (see below)
1. database_cross_reference
1. dbxref: Your ORCID (if you do not have an ORCID, sign up here: [https://orcid.org/](https://orcid.org/))
1. Under annotations, add synonyms, if necessary (has_exact_synonym, etc). If applicable, mark the synonyms as an [abbreviation](https://github.com/obophenotype/human-phenotype-ontology/wiki/Abbreviation-synonym-annotation) or [layperson term](https://github.com/obophenotype/human-phenotype-ontology/wiki/Layperson-synonym-annotation).

### Save

**do not edit any other files!!!**

### Commit your changes

~~~
  git diff
  git status
  git commit -a -m "COMMIT MESSAGE"
  git push
~~~

## CREATING NEW TERMS (Checklist)

* In general, the term should be announced on the GitHub tracker prior to creation of new term
* Make sure the Protege reasoner (Elk) is active to investigate any unforeseen and unintended logical inferences
* Most terms should have the following items added
** Label
** Definition (english-language). This should be extended by database_cross_reference (e.g., PMID:123 to provide additional information. _Note, there should be no spaces in the PMID._)
** Comment. This is optional but can be used to provide additional information about the term such as diseases that are characterized by the feature or diagnostic methods that can be used to demonstrated the feature
** database_cross_reference. Indicate an item in another database that is equivalent to this HPPO term. For instance, MeSH:D058529. We can add a label (e.g., "Single umbilical artery") by the "Annotations" button.
** If possible, add relevant synonyms. Use "has_exact_synonym" for true synonyms (preferred). If needed, use has_related_synonym for words/phrases that are not 100% identical in meaning but are likely to be confused with the main term.
* Note that "id" (e.g., HP:0001234) and "has_obo_namespace" (human_phenotype) were added automatically by the OBO to OWL conversion and are not required for new terms.


## Closing Issues with Commit Messages
This is the preferred way to commit a new term.  
See the [GitHub help pages for this](https://help.github.com/articles/closing-issues-via-commit-messages/).
To close and commit terms that relate to issue #608, for instance, create the terms and save them to file.
git add -u .
git commit -m "This closes #608"
git push


## OBSOLETING
---------------

!!! YOU NEED THE OBSOLESCENCE PLUGIN!!!! [https://github.com/balhoff/obo-actions/downloads](https://github.com/balhoff/obo-actions/downloads)

1. Find the  class you wish to obsolete, and compare it with the class you wish to replace (or consider) it with. You need to check that both the text definition and the logical axioms have the same intent, and that nothing desired is lost in the obsolescence.

2. Copy any subClass axioms that you intend to keep for historical purposes (e.g. those that are not replicated on the target class) into a comment annotation property. If you do this, please ensure to add to any exisiting comments rather than adding a new COMMENT. There can be only one COMMENT in obo format and Jenkins will throw an error. If there are equivalence axioms, you may wish to consult with an expert to make sure the axioms are retained properly in the file.

3. Go to the obsolescence plugin by going to the edit menu and scroll to the bottom, to "Make Entity Obsolete". This will perform the following for you:
	Relabel the class as "obsolete your old term label here".
	Add an annotation property, "deprecated", value "true", of type "boolean".
	Delete subClassOf axioms
You should see the class crossed out after you do this.

4. Add an annotation property "term replaced by". Navigate to the term by clicking on the "entity IRI" and either browse or control F to find the term that is replacing the one being obsoleted.

5. YOU HAVE TO ADD THE ALTERNATIVE-ID TAG to the class that replaces the obsolote class. All IDs of the old term have to be moved to this field!!

6. You may wish to add a comment regarding the reason for obsolescence or so as to include reference to why the term was replaced with whatever is indicated. Again, do not add more than one comment annotation on a class.

### SEARCHING BY URI
----------------
_**Note - this no longer applies in newer versions of Protege (ie Protege 5.0 and up)**_  
To view IDs instead of labels:  
View -> Render by name (rdf: id)  
search for ID  
View -> Render by label  
click on parent in description  
click back button to get back to your term  
(stupid, eh?)  


## MERGING
---------------
If you use the Refactor > Rename entity... menu item, and make the IRI of one term the same as the
IRI of another term, all the axioms are merged to one term.
Don't forget replaced_by and alt_id tags.


### SAVING and COMMITTING
---------------

Save and commit regularly. Always describe the changes you have made at a high level in the commit messages. It is a good idea to do a diff before committing (although the output can be hard to decipher, it can sometimes show you egregious errors, sometimes Protege's fault).

**Important: make sure you save in functional syntax, using the same prefixes as in the source file. This SHOULD be automatic (but Protege sometimes gets it wrong - one reason to do the diff).

**Important: there is currently a bug in Protege that is being investigated (well, there are many). If Protege asks you to name your merged file when you save and gives you no other option, DON'T DO IT. Quit Protege and start over. You will lose your work - another reason to save and commit in small increments.

If there are changes to the file after an SVN update, Protege will ask you to reload. You may wish not to trust the reload and simply reopen Protege.

After a commit, Travis will check your changes to make sure they conform to guidelines and do not introduce any inconsistencies - an email will be sent to the curators list.

You can check on the build here:
[https://travis-ci.org/obophenotype/human-phenotype-ontology](https://travis-ci.org/obophenotype/human-phenotype-ontology)

Check for errors in the report, send an email to curators if you cannot determine what the error is.

## MIREOTING
---------
Sometimes you may wish to reference a class from another ontology in the context of editing HP, and the term may not yet be MIREOT'd. You can currently pull in a new term from GO, Uberon, Chebi, CL, PATO or PR.

1. Identify the class to be included, and copy the URI (for example, look in Ontobee or open file in separate Protege instance and do control U to copy the URI). Note the superclass(es) of the class.

2. Whilst editing HP, change the "Active Ontology" file in the top header to the import file that will house the new class, for example, uberon_import.owl

3. Add a new class under the appropriate superclass in the import file, change the URI by doing control U and pasting the URI as per above. Make sure to add the label as an annotation so that you can find the class later.

4. Save the file (note that you should save in RDF/XML with the "use XML entities" checked in the Preferences/Save tab.

5. Do a Diff to make sure you are saving in the proper file format.

6. Advanced editors with Owltools - run "make imports", for example, make imports/uberon_import.owl  in the CL ontology directory. This will pull in the closure and add the metadata.

## CHECKLIST
---------

Always synchronize the reasoner before committing. Did your changes
introduce unsatisfiable classes? If so, investigate them.

For any classes you have created, are they in your ID range? Did you
add text definitions, adding provenance information? Is the reasoner finding unintended inferred equivalent classes? Subclasses?

Check the Travis report after your commits. This should alert you to
any of the following:

 * consistency problems with anatomy ontologies
 * consistency problems with other ontologies
 * violation of obo-format (e.g. two labels for a class; two text
   definitions; etc)
